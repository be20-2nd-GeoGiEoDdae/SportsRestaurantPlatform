<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ohgiraffers.geogieoddae.restaurant.query.mapper.RestaurantMapper">

    <!-- ============================
         1. 목록 조회 + 거리 정렬 지원
         ============================ -->
    <select id="getRestaurantList"
            parameterType="map"
            resultType="com.ohgiraffers.geogieoddae.restaurant.query.dto.RestaurantDto">

        SELECT
        r.restaurant_code AS restaurantCode,
        r.restaurant_name AS restaurantName,
        r.restaurant_location AS restaurantLocation,
        r.restaurant_category AS restaurantCategory,
        r.restaurant_people_number AS restaurantPeopleNumber,
        r.restaurant_contents AS restaurantContents,
        r.restaurant_score AS restaurantScore,
        r.created_at AS createdAt,

        <choose>
            <when test="userLat != null and userLng != null">
                (6371 * acos(
                cos(radians(#{userLat}))
                * cos(radians(r.latitude))
                * cos(radians(r.longitude) - radians(#{userLng}))
                + sin(radians(#{userLat}))
                * sin(radians(r.latitude))
                )) AS distance
            </when>
            <otherwise>
                null AS distance
            </otherwise>
        </choose>,

        (
        SELECT CONCAT('/uploads', p.restaurant_picture_url)
        FROM restaurant_picture p
        WHERE p.restaurant_code = r.restaurant_code
        LIMIT 1
        ) AS pictureUrls,

        (
        SELECT GROUP_CONCAT(k.keyword)
        FROM restaurant_keyword rk
        LEFT JOIN keyword k ON rk.keyword_code = k.keyword_code
        WHERE rk.restaurant_code = r.restaurant_code
        ) AS keywords

        FROM restaurant r

        <where>
            <if test="category != null and category != ''">
                r.restaurant_category = #{category}
            </if>
        </where>

        ORDER BY
        <choose>
            <when test="sort == 'distance'">
                (6371 * acos(
                cos(radians(#{userLat}))
                * cos(radians(r.latitude))
                * cos(radians(r.longitude) - radians(#{userLng}))
                + sin(radians(#{userLat}))
                * sin(radians(r.latitude))
                )) ASC
            </when>
            <when test="sort == 'name'">
                r.restaurant_name ASC
            </when>
            <when test="sort == 'score'">
                r.restaurant_score DESC
            </when>
            <otherwise>
                r.created_at DESC
            </otherwise>
        </choose>

        LIMIT #{size} OFFSET #{offset}
    </select>


    <!-- ============================
         2. 검색 + 카테고리 + 키워드
         ============================ -->
    <select id="findRestaurantList"
            parameterType="map"
            resultType="com.ohgiraffers.geogieoddae.restaurant.query.dto.RestaurantDto">

        SELECT
        r.restaurant_code AS restaurantCode,
        r.restaurant_name AS restaurantName,
        r.restaurant_location AS restaurantLocation,
        r.restaurant_category AS restaurantCategory,
        r.restaurant_people_number AS restaurantPeopleNumber,
        r.restaurant_contents AS restaurantContents,
        r.restaurant_score AS restaurantScore,
        GROUP_CONCAT(k.keyword) AS keywords,
        r.created_at AS createdAt

        FROM restaurant r
        LEFT JOIN restaurant_keyword rk ON r.restaurant_code = rk.restaurant_code
        LEFT JOIN keyword k ON rk.keyword_code = k.keyword_code

        <where>
            <if test="restaurant_name != null and restaurant_name != ''">
                r.restaurant_name LIKE CONCAT('%', #{restaurant_name}, '%')
            </if>

            <if test="keyword != null and keyword != ''">
                AND k.keyword LIKE CONCAT('%', #{keyword}, '%')
            </if>

            <if test="category != null and category != ''">
                AND r.restaurant_category = #{category}
            </if>
        </where>

        GROUP BY r.restaurant_code
        ORDER BY r.restaurant_name ASC
    </select>


    <!-- ============================
         3. 상세 조회
         ============================ -->
    <select id="findRestaurantDetail"
            parameterType="long"
            resultType="com.ohgiraffers.geogieoddae.restaurant.query.dto.RestaurantDto">

        SELECT
            r.restaurant_code AS restaurantCode,
            r.restaurant_name AS restaurantName,
            r.restaurant_location AS restaurantLocation,
            r.restaurant_category AS restaurantCategory,
            r.restaurant_people_number AS restaurantPeopleNumber,
            r.restaurant_contents AS restaurantContents,
            r.restaurant_score AS restaurantScore,
            GROUP_CONCAT(DISTINCT p.restaurant_picture_url) AS pictureUrls,
            GROUP_CONCAT(DISTINCT k.keyword) AS keywords,
            r.created_at AS createdAt

        FROM restaurant r
                 LEFT JOIN restaurant_picture p ON r.restaurant_code = p.restaurant_code
                 LEFT JOIN restaurant_keyword rk ON r.restaurant_code = rk.restaurant_code
                 LEFT JOIN keyword k ON rk.keyword_code = k.keyword_code

        WHERE r.restaurant_code = #{restaurantCode}

        GROUP BY r.restaurant_code
    </select>
    <!-- ============================
         4. 가게 사진 목록 조회용 쿼리
         ============================ -->
    <select id="findRestaurantImages"
            parameterType="long"
            resultType="string">

        SELECT CONCAT('/uploads', p.restaurant_picture_url)
        FROM restaurant_picture p
        WHERE p.restaurant_code = #{restaurantCode}

    </select>

</mapper>
