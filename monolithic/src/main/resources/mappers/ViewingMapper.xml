<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ohgiraffers.geogieoddae.viewing.query.mapper.ViewingMapper">

    <!-- 검색 -->
    <select id="searchViewingsByKeyword" parameterType="string"
            resultType="com.ohgiraffers.geogieoddae.viewing.query.dto.ViewingDto">
        SELECT v.viewing_code,
               v.viewing_title,
               v.viewing_body,
               v.viewing_at,
               v.viewing_total_deposit,
               v.viewing_status,
               v.viewing_min_num,
               v.viewing_max_num,
               r.restaurant_name AS restaurantName,
               s.sport_name AS sportName,
               t.team_name AS teamName
        FROM viewing v
                 JOIN restaurant r ON v.restaurant_code = r.restaurant_code
                 JOIN sport s ON v.sport_code = s.sport_code
                 JOIN team t ON v.team_code = t.team_code
        WHERE v.viewing_title LIKE CONCAT('%', #{keyword}, '%')
           OR v.viewing_body LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY v.created_at DESC
    </select>

    <select id="findAllViewings" resultType="com.ohgiraffers.geogieoddae.viewing.query.dto.ViewingDto">
        SELECT
        v.viewing_code AS viewingCode,
        v.viewing_title AS viewingTitle,
        v.viewing_body AS viewingBody,
        v.viewing_at,
        v.viewing_total_deposit,
        v.viewing_status,
        v.viewing_min_num,
        v.viewing_max_num,

        r.restaurant_name AS restaurantName,
        s.sport_name AS sportName,
        t.team_name AS teamName,

        (
        SELECT rp.restaurant_picture_url
        FROM restaurant_picture rp
        WHERE rp.restaurant_code = r.restaurant_code
        ORDER BY rp.restaurant_picture_code
        LIMIT 1
        ) AS pictureUrl,

        <!-- ⭐ 여기 콤마 필수! 이거 없어서 전체가 안 나왔던 거임 -->
        <choose>
            <when test="lat != null and lng != null">
                (6371 * acos(
                cos(radians(#{lat}))
                * cos(radians(r.latitude))
                * cos(radians(r.longitude) - radians(#{lng}))
                + sin(radians(#{lat})) * sin(radians(r.latitude))
                )) AS distance
            </when>
            <otherwise>
                null AS distance
            </otherwise>
        </choose>

        FROM viewing v
        JOIN restaurant r ON v.restaurant_code = r.restaurant_code
        JOIN sport s ON v.sport_code = s.sport_code
        JOIN team t ON v.team_code = t.team_code

        ORDER BY v.viewing_code DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>


    <!-- 조건별 조회 -->
    <select id="findViewingsByCondition"
            parameterType="map"
            resultType="com.ohgiraffers.geogieoddae.viewing.query.dto.ViewingDto">
        SELECT v.viewing_code,
               v.viewing_title,
               v.viewing_body,
               v.viewing_at,
               v.viewing_total_deposit,
               v.viewing_status,
               v.viewing_min_num,
               v.viewing_max_num,
               r.restaurant_name AS restaurantName,
               s.sport_name AS sportName,
               t.team_name AS teamName
        FROM viewing v
                 JOIN restaurant r ON v.restaurant_code = r.restaurant_code
                 JOIN sport s ON v.sport_code = s.sport_code
                 JOIN team t ON v.team_code = t.team_code
        WHERE (#{teamName} IS NULL OR t.team_name LIKE CONCAT('%', #{teamName}, '%'))
          AND (#{restaurantName} IS NULL OR r.restaurant_name LIKE CONCAT('%', #{restaurantName}, '%'))
          AND (#{sportName} IS NULL OR s.sport_name LIKE CONCAT('%', #{sportName}, '%'))
        ORDER BY v.created_at DESC
    </select>


        <!-- 상세 조회 -->
    <resultMap id="viewingPictureDtoMap" type="com.ohgiraffers.geogieoddae.viewing.query.dto.ViewingPictureDto">
        <id property="viewingCode" column="viewingCode"/>
        <result property="viewingTitle" column="viewingTitle"/>
        <result property="viewingBody" column="viewingBody"/>
        <result property="viewingAt" column="viewingAt"/>
        <result property="viewingTotalDeposit" column="viewingTotalDeposit"/>
        <result property="viewingStatus" column="viewingStatus"/>
        <result property="viewingMinNum" column="viewingMinNum"/>
        <result property="viewingMaxNum" column="viewingMaxNum"/>
        <result property="restaurantCode" column="restaurantCode"/>
        <result property="restaurantName" column="restaurantName"/>
        <result property="restaurantLocation" column="restaurantLocation"/>
        <result property="restaurantMaxNum" column="restaurantMaxNum"/>
        <result property="sportName" column="sportName"/>
        <result property="teamName" column="teamName"/>
        <result property="keywords" column="keywords"/>
    </resultMap>

    <select id="findViewingDetail"
            parameterType="long"
            resultMap="viewingPictureDtoMap">

        SELECT
            v.viewing_code AS viewingCode,
            v.viewing_title AS viewingTitle,
            v.viewing_body AS viewingBody,
            v.viewing_at AS viewingAt,
            v.viewing_total_deposit AS viewingTotalDeposit,
            v.viewing_status AS viewingStatus,

            v.viewing_min_num AS viewingMinNum,
            v.viewing_max_num AS viewingMaxNum,

            r.restaurant_code AS restaurantCode,
            r.restaurant_name AS restaurantName,
            r.restaurant_location AS restaurantLocation,
            r.restaurant_people_number AS restaurantMaxNum,

            s.sport_name AS sportName,
            t.team_name AS teamName,

            GROUP_CONCAT(k.keyword) AS keywords

        FROM viewing v
        JOIN restaurant r ON v.restaurant_code = r.restaurant_code
        JOIN sport s ON v.sport_code = s.sport_code
        JOIN team t ON v.team_code = t.team_code
        LEFT JOIN restaurant_keyword rk ON r.restaurant_code = rk.restaurant_code
        LEFT JOIN keyword k ON rk.keyword_code = k.keyword_code
        WHERE v.viewing_code = #{viewingCode}
        GROUP BY v.viewing_code, r.restaurant_code, s.sport_code, t.team_code
    </select>


    <!-- 키워드 로직은 findViewingDetail 쿼리에 통합됨 -->


        <!-- 레스토랑 사진 조회 -->
        <select id="findRestaurantPictures" parameterType="long" resultType="string">
            SELECT rp.restaurant_picture_url
            FROM restaurant_picture rp
            WHERE rp.restaurant_code = #{restaurantCode}
            ORDER BY rp.restaurant_picture_code
        </select>


    <select id="countAllViewings" resultType="int">
        SELECT COUNT(*)
        FROM viewing
    </select>
</mapper>
