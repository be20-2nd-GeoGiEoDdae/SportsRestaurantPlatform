<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <!-- v2 Standard SDK -->
  <script src="https://js.tosspayments.com/v2/standard"></script>
  <title>결제</title>
</head>
<body>
<div id="payment-method"></div>
<div id="agreement"></div>
<button id="pay">결제하기</button>

<script>
  (async () => {
    if (typeof TossPayments === 'undefined') {
      alert('토스 결제 SDK 로드 실패'); return;
    }

    // 초기화 값 로드/검증
    const raw = sessionStorage.getItem('checkout');
    let conf; try { conf = JSON.parse(raw || 'null'); } catch { conf = null; }
    if (!conf || !conf.clientKey || !conf.customerKey || !conf.amount) {
      alert('초기화 정보가 부족합니다. 처음 페이지에서 다시 진행해주세요.');
      location.href = '/viewing-pay.html'; return;
    }
    conf.amount = Number(conf.amount);

    //SDK 초기화 + 위젯 준비
    const tossPayments = TossPayments(conf.clientKey);
    const widgets = tossPayments.widgets({ customerKey: conf.customerKey });

    // 금액 설정 → UI 렌더
    await widgets.setAmount({ value: conf.amount, currency: "KRW" });
    await widgets.renderPaymentMethods({ selector: "#payment-method" });
    await widgets.renderAgreement({ selector: "#agreement" });

    // 결제 요청(매 클릭마다 새 orderId 생성)
    document.getElementById('pay').addEventListener('click', async () => {
      const orderId = (crypto?.randomUUID?.() ?? (Date.now() + '-' + Math.random().toString(16).slice(2)));
      try {
        await widgets.requestPayment({
          orderId,
          orderName: conf.orderName || 'ViewingPay 결제',
          successUrl: location.origin + '/pay/success',
          failUrl:    location.origin + '/fail',
          // 선택: 고객 표시용 정보
          // customerEmail: "customer123@gmail.com",
          // customerName:  "홍길동",
        });
      } catch (e) {
        console.error('[requestPayment error]', e?.code, e?.message, e);
        alert('결제호출에 실패했습니다. 콘솔 로그를 확인하세요.');
      }
    });
  })();
</script>
</body>
</html>
